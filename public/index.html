<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacay Hub - Urlaubsverwaltung</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4A90E2;
            --success: #52C41A;
            --danger: #F5222D;
            --warning: #FAAD14;
            --dark: #001529;
            --light: #F0F2F5;
            --border: #D9D9D9;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .auth-header p {
            color: #666;
            font-size: 14px;
        }
        
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 24px;
        }
        
        .header nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-badge {
            background: var(--light);
            padding: 8px 15px;
            border-radius: 20px;
            margin-right: 15px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #357ABD; }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #389E0D; }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #CF1322; }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #D48806; }
        
        .btn-secondary { background: #6C757D; color: white; }
        .btn-secondary:hover { background: #5A6268; }
        
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }
        
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .role-option {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .role-option:hover {
            border-color: var(--primary);
            background: var(--light);
        }
        
        .role-option.selected {
            border-color: var(--primary);
            background: #E6F7FF;
        }
        
        .role-option h4 { margin-bottom: 5px; color: #333; }
        .role-option p { font-size: 12px; color: #666; }
        
        .access-code-display {
            background: #E6F7FF;
            border: 2px dashed var(--primary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .access-code-display .code {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 2px;
            margin: 10px 0;
        }
        
        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-box h3 { margin-bottom: 10px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }
        
        .vacation-balance {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .vacation-balance-item {
            text-align: center;
        }
        
        .vacation-balance-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .vacation-balance-item .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        /* Improved Calendar */
        .calendar-container {
            margin-top: 20px;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-month {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 15px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }
        
        .calendar-day.other-month {
            background: #FAFAFA;
            opacity: 0.5;
        }
        
        .calendar-day.today {
            background: #FFF7E6;
        }
        
        .calendar-day-number {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .vacation-item {
            font-size: 11px;
            padding: 2px 5px;
            margin: 2px 0;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .vacation-item.approved {
            background: var(--success);
            color: white;
        }
        
        .vacation-item.pending {
            background: var(--warning);
            color: white;
        }
        
        .vacation-item.denied {
            background: var(--danger);
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        thead {
            background: var(--light);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.pending { background: #FFF7E6; color: var(--warning); }
        .status-badge.approved { background: #F6FFED; color: var(--success); }
        .status-badge.denied { background: #FFF1F0; color: var(--danger); }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light);
            margin-bottom: 20px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            color: var(--primary);
        }
        
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            background: var(--success);
            color: white;
        }
        
        .notification.error {
            background: var(--danger);
            color: white;
        }
        
        .notification.info {
            background: var(--primary);
            color: white;
        }
        
        .hidden { display: none !important; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth View -->
        <div id="authView" class="auth-container">
            <div class="auth-box">
                <div class="auth-header">
                    <h1>üèñ Vacay Hub</h1>
                    <p id="authSubtitle">Urlaubsverwaltung leicht gemacht</p>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="form-group">
                        <label>E-Mail</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="ihre.email@firma.de">
                    </div>
                    <div class="form-group">
                        <label>Passwort</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Anmelden</button>
                    <div style="text-align: center;">
                        <a href="#" onclick="showRegister()" style="color: var(--primary); text-decoration: none;">Neu hier? Jetzt registrieren</a>
                    </div>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <div id="registerStep1">
                        <p style="margin-bottom: 20px; color: #666;">W√§hlen Sie Ihre Registrierungsoption:</p>
                        <div style="display: grid; gap: 15px;">
                            <button onclick="showAdminRegister()" class="btn btn-primary" style="padding: 20px;">
                                <strong>üè¢ Neue Firma registrieren</strong><br>
                                <small style="opacity: 0.9;">Als Administrator einer neuen Firma</small>
                            </button>
                            <button onclick="showEmployeeRegister()" class="btn btn-secondary" style="padding: 20px;">
                                <strong>üë• Bestehender Firma beitreten</strong><br>
                                <small style="opacity: 0.9;">Mit Zugangscode vom Admin</small>
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <a href="#" onclick="showLogin()" style="color: #666; text-decoration: none;">‚Üê Zur√ºck zur Anmeldung</a>
                        </div>
                    </div>
                    
                    <!-- Admin Registration -->
                    <div id="adminRegisterForm" class="hidden">
                        <h3 style="margin-bottom: 20px;">Neue Firma registrieren</h3>
                        <div class="form-group">
                            <label>Ihr Name</label>
                            <input type="text" id="adminName" class="form-control" placeholder="Max Mustermann">
                        </div>
                        <div class="form-group">
                            <label>E-Mail</label>
                            <input type="email" id="adminEmail" class="form-control" placeholder="admin@firma.de">
                        </div>
                        <div class="form-group">
                            <label>Passwort</label>
                            <input type="password" id="adminPassword" class="form-control" placeholder="Mindestens 8 Zeichen">
                        </div>
                        <div class="form-group">
                            <label>Firmenname</label>
                            <input type="text" id="companyName" class="form-control" placeholder="Meine Firma GmbH">
                        </div>
                        <button onclick="registerAdmin()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Firma registrieren</button>
                        <div style="text-align: center;">
                            <a href="#" onclick="showRegister()" style="color: #666; text-decoration: none;">‚Üê Zur√ºck</a>
                        </div>
                    </div>
                    
                    <!-- Employee Registration -->
                    <div id="employeeRegisterForm" class="hidden">
                        <h3 style="margin-bottom: 20px;">Firma beitreten</h3>
                        <div class="form-group">
                            <label>Zugangscode der Firma</label>
                            <input type="text" id="accessCode" class="form-control" placeholder="z.B. VC-ABC123XYZ" style="text-transform: uppercase;">
                            <small style="color: #666;">Erhalten Sie von Ihrem Administrator</small>
                        </div>
                        <div class="form-group">
                            <label>Ihr Name</label>
                            <input type="text" id="empName" class="form-control" placeholder="Max Mustermann">
                        </div>
                        <div class="form-group">
                            <label>E-Mail</label>
                            <input type="email" id="empEmail" class="form-control" placeholder="ihre.email@firma.de">
                        </div>
                        <div class="form-group">
                            <label>Passwort</label>
                            <input type="password" id="empPassword" class="form-control" placeholder="Mindestens 8 Zeichen">
                        </div>
                        <div class="form-group">
                            <label>Rolle in der Firma</label>
                            <div class="role-selector">
                                <div class="role-option" onclick="selectRole('employee')" data-role="employee">
                                    <h4>üë§ Mitarbeiter</h4>
                                    <p>Standard-Benutzer</p>
                                </div>
                                <div class="role-option" onclick="selectRole('manager')" data-role="manager">
                                    <h4>üëî Manager</h4>
                                    <p>Kann Urlaub genehmigen</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="registerEmployee()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">Beitreten</button>
                        <div style="text-align: center;">
                            <a href="#" onclick="showRegister()" style="color: #666; text-decoration: none;">‚Üê Zur√ºck</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainView" class="hidden">
            <div class="container">
                <div class="header">
                    <div class="header-content">
                        <h1>üèñ Vacay Hub</h1>
                        <nav>
                            <div class="user-badge">
                                <span id="currentUser"></span>
                                <span id="userRole" style="margin-left: 10px;"></span>
                            </div>
                            <button onclick="showDashboard()" class="btn btn-primary">Dashboard</button>
                            <button onclick="showRequests()" class="btn btn-secondary">Anfragen</button>
                            <button onclick="showEmployees()" id="employeesBtn" class="btn btn-secondary hidden">Mitarbeiter</button>
                            <button onclick="showAdminPanel()" id="adminBtn" class="btn btn-warning hidden">Admin</button>
                            <button onclick="logout()" class="btn btn-danger">Abmelden</button>
                        </nav>
                    </div>
                </div>

                <!-- Dashboard -->
                <div id="dashboardView" class="section">
                    <h2 style="margin-bottom: 20px;">Dashboard</h2>
                    
                    <!-- Vacation Balance for Employees -->
                    <div id="vacationBalance" class="vacation-balance hidden">
                        <div class="vacation-balance-item">
                            <div class="label">GESAMT TAGE</div>
                            <div class="value" id="totalDays">30</div>
                        </div>
                        <div class="vacation-balance-item">
                            <div class="label">GENOMMEN</div>
                            <div class="value" id="usedDays">0</div>
                        </div>
                        <div class="vacation-balance-item">
                            <div class="label">VERF√úGBAR</div>
                            <div class="value" id="availableDays">30</div>
                        </div>
                    </div>
                    
                    <!-- Statistics for Managers/Admins -->
                    <div id="statsGrid" class="stats-grid hidden">
                        <div class="stat-card">
                            <h4>MITARBEITER</h4>
                            <div class="number" id="statEmployees">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>OFFENE ANTR√ÑGE</h4>
                            <div class="number" id="statPending">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>GENEHMIGT (MONAT)</h4>
                            <div class="number" id="statApproved">0</div>
                        </div>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-controls">
                            <button onclick="showRequestForm()" class="btn btn-success">+ Urlaub beantragen</button>
                            <div>
                                <span class="calendar-month" id="calendarMonth"></span>
                            </div>
                            <div>
                                <button onclick="prevMonth()" class="btn btn-secondary">‚Üê</button>
                                <button onclick="nextMonth()" class="btn btn-secondary" style="margin-left: 5px;">‚Üí</button>
                            </div>
                        </div>
                        
                        <div class="calendar">
                            <div class="calendar-header">Mo</div>
                            <div class="calendar-header">Di</div>
                            <div class="calendar-header">Mi</div>
                            <div class="calendar-header">Do</div>
                            <div class="calendar-header">Fr</div>
                            <div class="calendar-header">Sa</div>
                            <div class="calendar-header">So</div>
                        </div>
                    </div>
                </div>

                <!-- Request Form -->
                <div id="requestFormView" class="section hidden">
                    <h2>Urlaub beantragen</h2>
                    <div id="remainingDaysInfo" class="info-box">
                        <h3>Ihre Urlaubstage</h3>
                        <p>Sie haben noch <strong id="remainingDays">30</strong> Urlaubstage zur Verf√ºgung.</p>
                    </div>
                    <div class="form-group">
                        <label>Von</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Bis</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Bemerkung (optional)</label>
                        <textarea id="requestNote" class="form-control" rows="3" placeholder="Grund f√ºr den Urlaub..."></textarea>
                    </div>
                    <button onclick="submitRequest()" class="btn btn-success">Antrag einreichen</button>
                    <button onclick="showDashboard()" class="btn btn-secondary" style="margin-left: 10px;">Abbrechen</button>
                </div>

                <!-- Requests View -->
                <div id="requestsView" class="section hidden">
                    <h2>Urlaubsantr√§ge</h2>
                    <div class="tabs">
                        <button class="tab-button active" onclick="showTab('myRequests')">Meine Antr√§ge</button>
                        <button class="tab-button" onclick="showTab('pendingRequests')" id="pendingTab">Offene Antr√§ge</button>
                        <button class="tab-button" onclick="showTab('allRequests')" id="allTab">Alle Antr√§ge</button>
                    </div>
                    
                    <div id="myRequests" class="tab-content active"></div>
                    <div id="pendingRequests" class="tab-content"></div>
                    <div id="allRequests" class="tab-content"></div>
                </div>

                <!-- Employees Management (for Managers) -->
                <div id="employeesView" class="section hidden">
                    <h2>Mitarbeiterverwaltung</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>Rolle</th>
                                <th>Urlaubstage (Gesamt)</th>
                                <th>Genommen</th>
                                <th>Verf√ºgbar</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="employeesList"></tbody>
                    </table>
                </div>

                <!-- Admin Panel -->
                <div id="adminView" class="section hidden">
                    <h2>Admin Panel</h2>
                    
                    <div class="access-code-display">
                        <h3>Ihr Firmen-Zugangscode</h3>
                        <div class="code" id="companyAccessCode">VC-XXXXXXXX</div>
                        <p>Teilen Sie diesen Code mit neuen Mitarbeitern</p>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab-button active" onclick="showAdminTab('users')">Benutzer</button>
                        <button class="tab-button" onclick="showAdminTab('company')">Firmeneinstellungen</button>
                    </div>
                    
                    <div id="adminUsers" class="tab-content active"></div>
                    <div id="adminCompany" class="tab-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let selectedRole = 'employee';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // API Helper
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                
                if (response.status === 401) {
                    logout();
                    throw new Error('Session expired');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Auth Functions
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerStep1').classList.remove('hidden');
            document.getElementById('adminRegisterForm').classList.add('hidden');
            document.getElementById('employeeRegisterForm').classList.add('hidden');
        }

        function showAdminRegister() {
            document.getElementById('registerStep1').classList.add('hidden');
            document.getElementById('adminRegisterForm').classList.remove('hidden');
        }

        function showEmployeeRegister() {
            document.getElementById('registerStep1').classList.add('hidden');
            document.getElementById('employeeRegisterForm').classList.remove('hidden');
            // Set default role selection
            selectRole('employee');
        }

        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-role="${role}"]`).classList.add('selected');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Bitte alle Felder ausf√ºllen', 'error');
                return;
            }
            
            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                authToken = response.token;
                localStorage.setItem('authToken', authToken);
                currentUser = response.user;
                
                showMainView();
                showNotification('Erfolgreich angemeldet!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function registerAdmin() {
            const name = document.getElementById('adminName').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const companyName = document.getElementById('companyName').value;
            
            if (!name || !email || !password || !companyName) {
                showNotification('Bitte alle Felder ausf√ºllen', 'error');
                return;
            }
            
            try {
                const response = await apiCall('/auth/register-admin', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password, companyName })
                });
                
                // Show access code
                showNotification(`Firma registriert! Zugangscode: ${response.company.accessCode}`, 'success');
                
                // Auto-login
                authToken = response.token;
                localStorage.setItem('authToken', authToken);
                currentUser = response.user;
                
                setTimeout(() => {
                    showMainView();
                    // Show access code in admin panel
                    document.getElementById('companyAccessCode').textContent = response.company.accessCode;
                }, 2000);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function registerEmployee() {
            const accessCode = document.getElementById('accessCode').value;
            const name = document.getElementById('empName').value;
            const email = document.getElementById('empEmail').value;
            const password = document.getElementById('empPassword').value;
            
            if (!accessCode || !name || !email || !password) {
                showNotification('Bitte alle Felder ausf√ºllen', 'error');
                return;
            }
            
            try {
                const response = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        email,
                        password,
                        accessCode: accessCode.toUpperCase(),
                        role: selectedRole
                    })
                });
                
                authToken = response.token;
                localStorage.setItem('authToken', authToken);
                currentUser = response.user;
                
                showMainView();
                showNotification('Erfolgreich registriert!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('authView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('hidden');
            showLogin();
        }

        // Main View Functions
        async function showMainView() {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            
            // Update user info
            document.getElementById('currentUser').textContent = currentUser.name;
            
            const roleBadge = {
                'admin': 'üëë Admin',
                'manager': 'üëî Manager',
                'employee': 'üë§ Mitarbeiter'
            };
            document.getElementById('userRole').textContent = roleBadge[currentUser.role];
            
            // Show/hide role-specific buttons
            if (currentUser.role === 'admin') {
                document.getElementById('adminBtn').classList.remove('hidden');
                document.getElementById('employeesBtn').classList.remove('hidden');
            } else if (currentUser.role === 'manager') {
                document.getElementById('employeesBtn').classList.remove('hidden');
            }
            
            // Show/hide role-specific tabs
            if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                document.getElementById('pendingTab').style.display = 'inline-block';
                document.getElementById('allTab').style.display = 'inline-block';
            } else {
                document.getElementById('pendingTab').style.display = 'none';
                document.getElementById('allTab').style.display = 'none';
            }
            
            showDashboard();
            loadNotifications();
            
            // Load company info for admin
            if (currentUser.role === 'admin') {
                loadCompanyInfo();
            }
        }

        async function showDashboard() {
            hideAllViews();
            document.getElementById('dashboardView').classList.remove('hidden');
            
            // Show appropriate info based on role
            if (currentUser.role === 'employee') {
                document.getElementById('vacationBalance').classList.remove('hidden');
                document.getElementById('statsGrid').classList.add('hidden');
                updateVacationBalance();
            } else {
                document.getElementById('vacationBalance').classList.add('hidden');
                document.getElementById('statsGrid').classList.remove('hidden');
                loadStatistics();
            }
            
            renderCalendar();
        }

        function updateVacationBalance() {
            const total = currentUser.vacationDaysTotal || 30;
            const used = currentUser.vacationDaysUsed || 0;
            const available = total - used;
            
            document.getElementById('totalDays').textContent = total;
            document.getElementById('usedDays').textContent = used;
            document.getElementById('availableDays').textContent = available;
        }

        async function loadStatistics() {
            try {
                const stats = await apiCall('/stats');
                document.getElementById('statEmployees').textContent = stats.totalEmployees;
                document.getElementById('statPending').textContent = stats.pendingRequests;
                document.getElementById('statApproved').textContent = stats.approvedThisMonth;
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function renderCalendar() {
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            
            const firstDayIndex = firstDay.getDay() || 7;
            const lastDayDate = lastDay.getDate();
            const prevLastDayDate = prevLastDay.getDate();
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            const todayDate = today.getDate();
            
            // Get all requests
            try {
                const requests = await apiCall('/requests');
                
                let calendarHTML = '';
                const calendarGrid = document.querySelector('.calendar');
                
                // Clear existing calendar days (keep headers)
                const headers = calendarGrid.querySelectorAll('.calendar-header');
                calendarGrid.innerHTML = '';
                headers.forEach(header => calendarGrid.appendChild(header));
                
                // Previous month days
                for (let i = firstDayIndex - 1; i > 0; i--) {
                    const day = prevLastDayDate - i + 1;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                    calendarGrid.appendChild(dayDiv);
                }
                
                // Current month days
                for (let day = 1; day <= lastDayDate; day++) {
                    const currentDate = new Date(currentYear, currentMonth, day);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    if (isCurrentMonth && day === todayDate) {
                        dayDiv.classList.add('today');
                    }
                    
                    // Find vacations for this day
                    const dayVacations = requests.filter(req => {
                        const start = new Date(req.start_date);
                        const end = new Date(req.end_date);
                        return currentDate >= start && currentDate <= end;
                    });
                    
                    let vacationHTML = '';
                    dayVacations.forEach(vacation => {
                        if (vacation.status === 'approved' || 
                            (vacation.status === 'pending' && (currentUser.role === 'manager' || currentUser.role === 'admin'))) {
                            vacationHTML += `<div class="vacation-item ${vacation.status}">${vacation.user_name.split(' ')[0]}</div>`;
                        }
                    });
                    
                    dayDiv.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        ${vacationHTML}
                    `;
                    
                    calendarGrid.appendChild(dayDiv);
                }
                
                // Next month days
                const remainingDays = 42 - (firstDayIndex - 1 + lastDayDate);
                for (let day = 1; day <= remainingDays; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                    calendarGrid.appendChild(dayDiv);
                }
            } catch (error) {
                console.error('Failed to load calendar data:', error);
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        async function showRequestForm() {
            hideAllViews();
            document.getElementById('requestFormView').classList.remove('hidden');
            
            // Update remaining days
            const available = currentUser.vacationDaysTotal - currentUser.vacationDaysUsed;
            document.getElementById('remainingDays').textContent = available;
            
            // Set default dates
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = tomorrow;
        }

        async function submitRequest() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const note = document.getElementById('requestNote').value;
            
            if (!startDate || !endDate) {
                showNotification('Bitte Start- und Enddatum w√§hlen!', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Enddatum muss nach Startdatum liegen!', 'error');
                return;
            }
            
            try {
                await apiCall('/requests', {
                    method: 'POST',
                    body: JSON.stringify({ startDate, endDate, note })
                });
                
                showNotification('Urlaubsantrag erfolgreich eingereicht!', 'success');
                showDashboard();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function showRequests() {
            hideAllViews();
            document.getElementById('requestsView').classList.remove('hidden');
            loadRequests();
        }

        async function loadRequests() {
            try {
                const requests = await apiCall('/requests');
                
                // My requests
                const myRequests = requests.filter(r => r.user_id === currentUser.id);
                let myHTML = '<table><thead><tr><th>Von</th><th>Bis</th><th>Tage</th><th>Status</th><th>Bemerkung</th></tr></thead><tbody>';
                
                myRequests.forEach(req => {
                    myHTML += `
                        <tr>
                            <td>${formatDate(req.start_date)}</td>
                            <td>${formatDate(req.end_date)}</td>
                            <td>${req.days_count}</td>
                            <td><span class="status-badge ${req.status}">${req.status.toUpperCase()}</span></td>
                            <td>${req.note || '-'}</td>
                        </tr>
                    `;
                });
                
                myHTML += '</tbody></table>';
                document.getElementById('myRequests').innerHTML = myHTML;
                
                // Pending requests (for managers)
                if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                    const pendingReqs = requests.filter(r => r.status === 'pending' && r.user_id !== currentUser.id);
                    let pendingHTML = '<table><thead><tr><th>Mitarbeiter</th><th>Von</th><th>Bis</th><th>Tage</th><th>Bemerkung</th><th>Aktionen</th></tr></thead><tbody>';
                    
                    pendingReqs.forEach(req => {
                        pendingHTML += `
                            <tr>
                                <td>${req.user_name}</td>
                                <td>${formatDate(req.start_date)}</td>
                                <td>${formatDate(req.end_date)}</td>
                                <td>${req.days_count}</td>
                                <td>${req.note || '-'}</td>
                                <td>
                                    <button onclick="approveRequest(${req.id})" class="btn btn-success">Genehmigen</button>
                                    <button onclick="denyRequest(${req.id})" class="btn btn-danger" style="margin-left: 5px;">Ablehnen</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    pendingHTML += '</tbody></table>';
                    document.getElementById('pendingRequests').innerHTML = pendingHTML;
                    
                    // All requests
                    let allHTML = '<table><thead><tr><th>Mitarbeiter</th><th>Von</th><th>Bis</th><th>Tage</th><th>Status</th><th>Genehmigt von</th></tr></thead><tbody>';
                    
                    requests.forEach(req => {
                        allHTML += `
                            <tr>
                                <td>${req.user_name}</td>
                                <td>${formatDate(req.start_date)}</td>
                                <td>${formatDate(req.end_date)}</td>
                                <td>${req.days_count}</td>
                                <td><span class="status-badge ${req.status}">${req.status.toUpperCase()}</span></td>
                                <td>${req.manager_name || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    allHTML += '</tbody></table>';
                    document.getElementById('allRequests').innerHTML = allHTML;
                }
            } catch (error) {
                showNotification('Fehler beim Laden der Antr√§ge', 'error');
            }
        }

        async function approveRequest(requestId) {
            try {
                await apiCall(`/requests/${requestId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'approved' })
                });
                
                showNotification('Antrag genehmigt!', 'success');
                loadRequests();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function denyRequest(requestId) {
            try {
                await apiCall(`/requests/${requestId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'denied' })
                });
                
                showNotification('Antrag abgelehnt!', 'info');
                loadRequests();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function showEmployees() {
            if (currentUser.role !== 'manager' && currentUser.role !== 'admin') {
                showNotification('Keine Berechtigung!', 'error');
                return;
            }
            
            hideAllViews();
            document.getElementById('employeesView').classList.remove('hidden');
            loadEmployees();
        }

        async function loadEmployees() {
            try {
                const users = await apiCall('/users');
                let html = '';
                
                users.forEach(user => {
                    const available = user.vacation_days_total - user.vacation_days_used;
                    html += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>
                                <input type="number" value="${user.vacation_days_total}" 
                                       id="days-${user.id}" style="width: 60px;" 
                                       ${currentUser.role !== 'manager' && currentUser.role !== 'admin' ? 'disabled' : ''}>
                            </td>
                            <td>${user.vacation_days_used}</td>
                            <td>${available}</td>
                            <td>
                                ${(currentUser.role === 'manager' || currentUser.role === 'admin') && user.id !== currentUser.id ? 
                                    `<button onclick="updateVacationDays(${user.id})" class="btn btn-primary">Speichern</button>` : 
                                    '-'}
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('employeesList').innerHTML = html;
            } catch (error) {
                showNotification('Fehler beim Laden der Mitarbeiter', 'error');
            }
        }

        async function updateVacationDays(userId) {
            const days = document.getElementById(`days-${userId}`).value;
            
            try {
                await apiCall(`/users/${userId}/vacation-days`, {
                    method: 'PUT',
                    body: JSON.stringify({ vacationDaysTotal: parseInt(days) })
                });
                
                showNotification('Urlaubstage aktualisiert!', 'success');
                loadEmployees();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function showAdminPanel() {
            if (currentUser.role !== 'admin') {
                showNotification('Keine Berechtigung!', 'error');
                return;
            }
            
            hideAllViews();
            document.getElementById('adminView').classList.remove('hidden');
            loadAdminData();
        }

        async function loadCompanyInfo() {
            try {
                const company = await apiCall('/company');
                if (company && company.access_code) {
                    document.getElementById('companyAccessCode').textContent = company.access_code;
                }
            } catch (error) {
                console.error('Failed to load company info:', error);
            }
        }

        async function loadAdminData() {
            // Load users
            try {
                const users = await apiCall('/users');
                let usersHTML = '<h3>Benutzerverwaltung</h3><table><thead><tr><th>Name</th><th>E-Mail</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead><tbody>';
                
                users.forEach(user => {
                    usersHTML += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>
                                ${user.id !== currentUser.id ? `
                                    <select id="role-${user.id}" style="width: auto;">
                                        <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Mitarbeiter</option>
                                        <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                ` : user.role}
                            </td>
                            <td>${user.active ? 'Aktiv' : 'Inaktiv'}</td>
                            <td>
                                ${user.id !== currentUser.id ? `
                                    <button onclick="updateUserRole(${user.id})" class="btn btn-primary">Rolle √§ndern</button>
                                    <button onclick="toggleUserStatus(${user.id})" class="btn ${user.active ? 'btn-danger' : 'btn-success'}">
                                        ${user.active ? 'Deaktivieren' : 'Aktivieren'}
                                    </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                });
                
                usersHTML += '</tbody></table>';
                document.getElementById('adminUsers').innerHTML = usersHTML;
                
                // Load company settings
                const company = await apiCall('/company');
                let companyHTML = `
                    <h3>Firmeneinstellungen</h3>
                    <div class="form-group">
                        <label>Firmenname</label>
                        <input type="text" id="companyName" class="form-control" value="${company.name}">
                    </div>
                    <div class="form-group">
                        <label>Arbeitstage pro Woche</label>
                        <input type="number" id="workDays" class="form-control" value="${company.work_days}" min="1" max="7">
                    </div>
                    <div class="form-group">
                        <label>J√§hrliche Urlaubstage (Standard)</label>
                        <input type="number" id="vacationDays" class="form-control" value="${company.vacation_days}" min="0">
                    </div>
                    <button onclick="saveCompanySettings()" class="btn btn-primary">Einstellungen speichern</button>
                `;
                document.getElementById('adminCompany').innerHTML = companyHTML;
                
            } catch (error) {
                showNotification('Fehler beim Laden der Admin-Daten', 'error');
            }
        }

        async function updateUserRole(userId) {
            const role = document.getElementById(`role-${userId}`).value;
            
            try {
                await apiCall(`/users/${userId}/role`, {
                    method: 'PUT',
                    body: JSON.stringify({ role })
                });
                
                showNotification('Rolle aktualisiert!', 'success');
                loadAdminData();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function toggleUserStatus(userId) {
            try {
                await apiCall(`/users/${userId}/toggle-active`, {
                    method: 'PUT'
                });
                
                showNotification('Benutzerstatus aktualisiert!', 'success');
                loadAdminData();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function saveCompanySettings() {
            const name = document.getElementById('companyName').value;
            const workDays = document.getElementById('workDays').value;
            const vacationDays = document.getElementById('vacationDays').value;
            
            try {
                await apiCall('/company', {
                    method: 'PUT',
                    body: JSON.stringify({
                        name,
                        workDays: parseInt(workDays),
                        vacationDays: parseInt(vacationDays),
                        plan: 'free'
                    })
                });
                
                showNotification('Einstellungen gespeichert!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function loadNotifications() {
            try {
                const notifications = await apiCall('/notifications');
                
                notifications.forEach(notification => {
                    showNotification(notification.message, 'info');
                });
                
                if (notifications.length > 0) {
                    await apiCall('/notifications/read', { method: 'PUT' });
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        // Tab functions
        function showTab(tabName) {
            document.querySelectorAll('#requestsView .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#requestsView .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showAdminTab(tabName) {
            document.querySelectorAll('#adminView .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#adminView .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            event.target.classList.add('active');
        }

        // Helper functions
        function hideAllViews() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('requestFormView').classList.add('hidden');
            document.getElementById('requestsView').classList.add('hidden');
            document.getElementById('employeesView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('de-DE');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Check for existing session on load
        async function checkAuth() {
            if (authToken) {
                try {
                    // Verify token by making an API call
                    const response = await apiCall('/company');
                    
                    // If successful, we have a valid session
                    // Get user info from token (you might want to add an endpoint for this)
                    // For now, we'll need to re-login
                    logout();
                } catch (error) {
                    logout();
                }
            }
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
